<!doctype html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no" />
  <title>Evermark Beta - Content Curation on Blockchain</title>

  <!-- Farcaster Mini App Embed Meta Tags -->
  <meta name="fc:miniapp" content="1" />
  <meta name="fc:miniapp:image" content="https://evermarks.net/og-image.png" />
  <meta name="fc:miniapp:button:1" content="üìñ Open Evermark" />
  <meta name="fc:miniapp:button:1:action" content="link" />
  <meta name="fc:miniapp:button:1:target" content="https://evermarks.net" />

  <!-- Open Graph Meta Tags -->
  <meta property="og:title" content="Evermark Beta - Content Curation on Blockchain" />
  <meta property="og:description" content="Preserve and curate your favorite content on the blockchain. Vote on quality content and participate in community-driven leaderboards." />
  <meta property="og:image" content="https://evermarks.net/og-image.png" />
  <meta property="og:url" content="https://evermarks.net" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Evermark Beta" />

  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Evermark Beta - Content Curation on Blockchain" />
  <meta name="twitter:description" content="Preserve and curate your favorite content on the blockchain. Vote on quality content and participate in community-driven leaderboards." />
  <meta name="twitter:image" content="https://evermarks.net/og-image.png" />

  <!-- App Meta Tags -->
  <meta name="description" content="Preserve and curate your favorite content on the blockchain. Vote on quality content and participate in community-driven leaderboards." />
  <meta name="keywords" content="blockchain, content curation, voting, farcaster, web3, evermark, mini app" />
  <meta name="author" content="Evermark" />

  <!-- Theme and Icons - Fixed with fallback -->
  <meta name="theme-color" content="#8B5CF6" />
  
  <!-- Immediate mobile detection to prevent desktop flash -->
  <script>
    (function() {
      var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|mobile/i.test(navigator.userAgent) ||
                     window.innerWidth <= 768;
      if (isMobile) {
        document.documentElement.classList.add('mobile-device');
      } else {
        document.documentElement.classList.add('desktop-device');
      }
    })();
  </script>
  <!-- Use data URI as fallback if icon.png doesn't exist -->
  <link rel="icon" type="image/png" href="/icon.png" onerror="this.href='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iOCIgZmlsbD0iIzhCNUNGNiIvPgo8cGF0aCBkPSJNMTYgMjRDMjAuNDE4MyAyNCAyNCAyMC40MTgzIDI0IDE2QzI0IDExLjU4MTcgMjAuNDE4MyA4IDE2IDhDMTEuNTgxNyA4IDggMTEuNTgxNyA4IDE2QzggMjAuNDE4MyAxMS41ODE3IDI0IDE2IDI0WiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+'" />
  <link rel="apple-touch-icon" href="/icon.png" />
  <!-- Fixed manifest.json reference -->
  <link rel="manifest" href="/manifest.json" />

  <!-- FIXED: Node.js Polyfill for Thirdweb v5 compatibility -->
  <script>
    // Minimal polyfill for Thirdweb's Node.js dependencies
    // This fixes "process is not defined" error in browser
    if (typeof process === 'undefined') {
      window.process = { 
        env: { 
          NODE_ENV: 'production',
          // Add any other env vars that Thirdweb might need
        },
        browser: true,
        version: 'v18.0.0'
      };
    }
    
    // Also ensure global is available for some libraries
    if (typeof global === 'undefined') {
      window.global = window;
    }
  </script>

  <!-- Farcaster Detection Script -->
  <script>
    // Enhanced Farcaster detection for frame/mini-app context
    window.__evermark_farcaster_detected = (() => {
      const ua = navigator.userAgent.toLowerCase();
      const url = window.location.href.toLowerCase();
      
      // Development mode override - add ?farcaster=true to test in browser
      const devOverride = window.location.search.includes('farcaster=true') || 
                         window.location.search.includes('fc=true');
      
      // Strong indicators of Farcaster environment
      const strongIndicators = 
        ua.includes('farcaster-') ||
        ua.includes('warpcast-app') ||
        url.includes('farcaster.xyz') ||
        url.includes('warpcast.com') ||
        window.location.search.includes('inFeed=true') ||
        window.location.search.includes('action_type=share') ||
        devOverride;
      
      console.log('üîç Farcaster Detection:', {
        detected: strongIndicators,
        userAgent: ua.substring(0, 50),
        url: url.substring(0, 50),
        devOverride: devOverride
      });
      
      return strongIndicators;
    })();

    // Preload Farcaster SDK if in Farcaster environment
    if (window.__evermark_farcaster_detected) {
      console.log('üì± Preloading Farcaster SDK...');
      const link = document.createElement('link');
      link.rel = 'preload';
      link.href = 'https://cdn.jsdelivr.net/npm/@farcaster/frame-sdk@latest/dist/index.min.js';
      link.as = 'script';
      link.crossOrigin = 'anonymous';
      document.head.appendChild(link);
    }
  </script>
</head>
<body class="bg-black text-white">
  <div id="root"></div>

  <!-- Farcaster SDK Initialization -->
  <script>
    (function() {
      // ALWAYS try to load SDK for Mini Apps, regardless of detection
      console.log('üîÑ Loading Farcaster SDK for Mini App support...');
      
      // Load and initialize Farcaster SDK
      const loadSDK = () => {
        return new Promise((resolve, reject) => {
          if (window.FrameSDK) {
            console.log('‚úÖ SDK already available');
            resolve(true);
            return;
          }
          
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/@farcaster/frame-sdk@latest/dist/index.min.js';
          script.crossOrigin = 'anonymous';
          script.async = true;
          
          script.onload = () => {
            console.log('‚úÖ SDK loaded');
            resolve(true);
          };
          
          script.onerror = (error) => {
            console.error('‚ùå SDK load failed:', error);
            reject(error);
          };
          
          document.head.appendChild(script);
        });
      };
      
      // Initialize SDK with timeout
      const initSDK = async () => {
        try {
          await loadSDK();
          
          // Wait for SDK with reasonable timeout
          let attempts = 0;
          while (!window.FrameSDK && attempts < 30) {
            await new Promise(resolve => setTimeout(resolve, 100));
            attempts++;
          }
          
          if (window.FrameSDK?.actions?.ready) {
            await window.FrameSDK.actions.ready({ disableNativeGestures: true });
            console.log('‚úÖ SDK ready');
          } else {
            console.log('‚ö†Ô∏è SDK not available');
          }
          
        } catch (error) {
          console.error('‚ùå SDK init failed:', error);
        }
      };
      
      // Initialize after DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initSDK);
      } else {
        setTimeout(initSDK, 100);
      }
      
      // Simple message handler
      window.addEventListener('message', function(event) {
        if (event.data?.type === 'frameEvent' || event.data?.source === 'farcaster') {
          console.log('üì® Farcaster message:', event.data.type);
        }
      }, false);
      
    })();
  </script>

  <script type="module" src="/src/main.tsx"></script>
</body>
</html>